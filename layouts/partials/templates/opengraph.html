{{- /* Generate dynamic OG image with Tokyo Night theme */ -}}
{{- $ogImage := "" }}

{{- /* Only generate for pages (not homepage/lists) */ -}}
{{- if .IsPage }}
  {{- /* Load base pattern image */ -}}
  {{- $base := resources.Get "og-base.png" }}

  {{- if $base }}
    {{- /* Load fonts */ -}}
    {{- $fontBold := resources.Get "IBMPlexMono-Bold.ttf" }}
    {{- $fontMedium := resources.Get "IBMPlexMono-Medium.ttf" }}

    {{- if and $fontBold $fontMedium }}
      {{- /* Get title and description */ -}}
      {{- $title := printf "%s" (.Title | plainify | chomp) }}
      {{- $description := "" }}
      {{- with .Description }}
        {{- $description = printf "%s" (. | plainify | chomp) }}
      {{- else }}
        {{- /* Use first paragraph only, strip HTML, limit to 120 chars */ -}}
        {{- $summary := .Summary | plainify | chomp }}
        {{- $description = printf "%s" ($summary | truncate 120) }}
      {{- end }}

      {{- /* Build image with text overlays */ -}}
      {{- $img := $base }}

      {{- /* Add title text */ -}}
      {{- $titleOpts := dict
        "color" "#7aa2f7"
        "size" 68
        "linespacing" 10
        "x" 100
        "y" 150
        "font" $fontBold
      }}
      {{- $titleFilter := images.Text $title $titleOpts }}
      {{- $img = $img.Filter $titleFilter }}

      {{- /* Add description text if exists */ -}}
      {{- if $description }}
        {{- $descOpts := dict
          "color" "#c0caf5"
          "size" 32
          "linespacing" 8
          "x" 100
          "y" 380
          "font" $fontMedium
        }}
        {{- $descFilter := images.Text $description $descOpts }}
        {{- $img = $img.Filter $descFilter }}
      {{- end }}

      {{- /* Add site name in bottom right */ -}}
      {{- $siteOpts := dict
        "color" "#7aa2f7"
        "size" 28
        "x" 920
        "y" 570
        "font" $fontMedium
      }}
      {{- $siteFilter := images.Text "blog.rbby.dev" $siteOpts }}
      {{- $img = $img.Filter $siteFilter }}

      {{- /* Store the generated image */ -}}
      {{- $ogImage = $img }}
    {{- end }}
  {{- end }}
{{- end }}

{{- /* Output OpenGraph meta tags */ -}}
<meta property="og:url" content="{{ .Permalink }}">

{{- with or site.Title site.Params.title | plainify }}
  <meta property="og:site_name" content="{{ . }}">
{{- end }}

{{- with or .Title site.Title site.Params.title | plainify }}
  <meta property="og:title" content="{{ . }}">
{{- end }}

{{- with or .Description .Summary site.Params.description | plainify | htmlUnescape | chomp }}
  <meta property="og:description" content="{{ . }}">
{{- end }}

{{- with or .Params.locale site.Language.LanguageCode site.Language.Lang }}
  <meta property="og:locale" content="{{ . }}">
{{- end }}

{{- if .IsPage }}
  <meta property="og:type" content="article">
  {{- with .Section }}
    <meta property="article:section" content="{{ . }}">
  {{- end }}
  {{- $ISO8601 := "2006-01-02T15:04:05-07:00" }}
  {{- with .PublishDate }}
    <meta property="article:published_time" {{ .Format $ISO8601 | printf "content=%q" | safeHTMLAttr }}>
  {{- end }}
  {{- with .Lastmod }}
    <meta property="article:modified_time" {{ .Format $ISO8601 | printf "content=%q" | safeHTMLAttr }}>
  {{- end }}
  {{- range .GetTerms "tags" | first 6 }}
    <meta property="article:tag" content="{{ .Page.Title | plainify }}">
  {{- end }}
{{- else }}
  <meta property="og:type" content="website">
{{- end }}

{{- /* Use our generated image if available */ -}}
{{- if $ogImage }}
  <meta property="og:image" content="{{ $ogImage.Permalink }}">
  <meta property="og:image:width" content="{{ $ogImage.Width }}">
  <meta property="og:image:height" content="{{ $ogImage.Height }}">
{{- else }}
  {{- /* Fallback to cover image or default */ -}}
  {{- if .Params.cover.image -}}
    {{- if (ne .Params.cover.relative true) }}
      <meta property="og:image" content="{{ .Params.cover.image | absURL }}">
    {{- else}}
      <meta property="og:image" content="{{ (path.Join .RelPermalink .Params.cover.image ) | absURL }}">
    {{- end}}
  {{- else }}
    {{- with partial "_funcs/get-page-images" . }}
      {{- range . | first 6 }}
        <meta property="og:image" content="{{ .Permalink }}">
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- with .Params.audio }}
  {{- range . | first 6  }}
    <meta property="og:audio" content="{{ . | absURL }}">
  {{- end }}
{{- end }}

{{- with .Params.videos }}
  {{- range . | first 6 }}
    <meta property="og:video" content="{{ . | absURL }}">
  {{- end }}
{{- end }}

{{- range .GetTerms "series" }}
  {{- range .Pages | first 7 }}
    {{- if ne $ . }}
      <meta property="og:see_also" content="{{ .Permalink }}">
    {{- end }}
  {{- end }}
{{- end }}

{{- with site.Params.social }}
  {{- if reflect.IsMap . }}
    {{- with .facebook_app_id }}
      <meta property="fb:app_id" content="{{ . }}">
    {{- else }}
      {{- with .facebook_admin }}
        <meta property="fb:admins" content="{{ . }}">
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- with (.Param "social.fediverse_creator") }}
  <meta name="fediverse:creator" content="{{ . }}">
{{- end }}
